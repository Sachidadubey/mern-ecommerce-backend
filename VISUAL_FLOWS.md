# ğŸ¨ Complete Visual Flow Diagrams

## 1. Rate Limiting Flow Diagram

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      REQUEST ARRIVES                                â”‚
â”‚                           â†“                                         â”‚
â”‚                 app.use("/api", limiter)                           â”‚
â”‚        (100 requests per 1 hour from same IP)                      â”‚
â”‚                           â†“                                         â”‚
â”‚           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                        â”‚
â”‚           â”‚   Check request count:        â”‚                        â”‚
â”‚           â”‚   â”œâ”€ From same IP? âœ“          â”‚                        â”‚
â”‚           â”‚   â”œâ”€ Within 1 hour? âœ“         â”‚                        â”‚
â”‚           â”‚   â””â”€ < 100 requests? ?        â”‚                        â”‚
â”‚           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                        â”‚
â”‚                           â†“                                         â”‚
â”‚           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                        â”‚
â”‚           â”‚     YES                NO      â”‚                        â”‚
â”‚           â”‚      â†“                 â†“       â”‚                        â”‚
â”‚           â”‚   Continue      Return 429    â”‚                        â”‚
â”‚           â”‚      â†“           "Too many     â”‚                        â”‚
â”‚           â”‚   requests"                   â”‚                        â”‚
â”‚           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                        â”‚
â”‚                           â†“                                         â”‚
â”‚              Is it /api/auth/login?                                â”‚
â”‚                  NO    â†“    YES                                     â”‚
â”‚                  â†“           â†“                                      â”‚
â”‚            Continue    app.post("/api/auth/login",                â”‚
â”‚               â†“              authLimiter)                          â”‚
â”‚           Route handler    (5 requests per 15 min)                â”‚
â”‚                                 â†“                                  â”‚
â”‚                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”‚
â”‚                    â”‚ Track only FAILED        â”‚                    â”‚
â”‚                    â”‚ attempts                 â”‚                    â”‚
â”‚                    â”‚ skipSuccessfulRequests   â”‚                    â”‚
â”‚                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â”‚
â”‚                                 â†“                                  â”‚
â”‚                    Count < 5?  âœ“ / âœ—                              â”‚
â”‚                         â†“         â†“                                â”‚
â”‚                      Continue  Return 429                         â”‚
â”‚                                                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Real-time Counter Example:

```
IP: 192.168.1.100

General Limiter (/api):           Auth Limiter (/api/auth/login):
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Window: 1 hour           â”‚     â”‚ Window: 15 minutes           â”‚
â”‚ 60 min timer             â”‚     â”‚ 15 min timer                 â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€      â”‚     â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€          â”‚
â”‚ Requests: 47/100         â”‚     â”‚ Failed attempts: 3/5         â”‚
â”‚ â”œâ”€ 10:00 - 5 req         â”‚     â”‚ â”œâ”€ 10:00:00 - Fail âœ—         â”‚
â”‚ â”œâ”€ 10:05 - 12 req        â”‚     â”‚ â”œâ”€ 10:00:05 - Fail âœ—         â”‚
â”‚ â”œâ”€ 10:10 - 8 req         â”‚     â”‚ â”œâ”€ 10:00:10 - Fail âœ—         â”‚
â”‚ â”œâ”€ 10:15 - 22 req        â”‚     â”‚ â””â”€ 10:00:15 - Success âœ“      â”‚
â”‚ â””â”€ Time left: 45 min     â”‚     â”‚     (doesn't count)          â”‚
â”‚                          â”‚     â”‚ â”œâ”€ 10:00:20 - Fail âœ—         â”‚
â”‚ Status: âœ… OK to request â”‚     â”‚ â””â”€ 10:00:25 - Fail âœ—         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚ Time left: 14 min            â”‚
                                 â”‚ Status: âœ… OK to request     â”‚
                                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 2. Complete Payment Flow (Step by Step)

```
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘              E-COMMERCE PAYMENT COMPLETE FLOW                       â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ PHASE 1: USER ADDS ITEMS & CHECKS OUT                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                     â”‚
â”‚  Frontend                    Backend                 Database       â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€                    â”€â”€â”€â”€â”€â”€â”€                 â”€â”€â”€â”€â”€â”€â”€â”€       â”‚
â”‚                                                                     â”‚
â”‚  1. Add to Cart â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ POST /api/cart                         â”‚
â”‚                            â”œâ”€ Validate user              âœ“         â”‚
â”‚                            â”œâ”€ Validate product           âœ“         â”‚
â”‚                            â””â”€ Add to cart DB        CART {item}    â”‚
â”‚                                                                     â”‚
â”‚  2. Click Checkout â”€â”€â”€â”€â”€â”€â†’ POST /api/orders                        â”‚
â”‚                            â”œâ”€ Validate cart              âœ“         â”‚
â”‚                            â”œâ”€ Validate stock             âœ“         â”‚
â”‚                            â”œâ”€ CREATE order      ORDER {status:PENDING}
â”‚                            â”œâ”€ DEDUCT stock      PRODUCT {stock-n}  â”‚
â”‚                            â”œâ”€ CLEAR cart                CART {}    â”‚
â”‚                            â””â”€ Return orderId                       â”‚
â”‚                              â†“                                     â”‚
â”‚  Get orderId â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ {orderId: "123"}                       â”‚
â”‚                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ PHASE 2: INITIATE PAYMENT                                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                     â”‚
â”‚  Frontend                    Backend              Razorpay        Database
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€                    â”€â”€â”€â”€â”€â”€â”€              â”€â”€â”€â”€â”€â”€â”€â”€         â”€â”€â”€â”€â”€â”€â”€â”€
â”‚                                                                     â”‚
â”‚  3. Request Payment â”€â”€â†’ POST /api/payment/create-order             â”‚
â”‚     {orderId: "123"}    createPaymentService()                     â”‚
â”‚                         â”œâ”€ Order exists?          âœ“               â”‚
â”‚                         â”œâ”€ User owns order?       âœ“               â”‚
â”‚                         â”œâ”€ Already paid?         NO âœ“             â”‚
â”‚                         â”œâ”€ Cancelled?            NO âœ“             â”‚
â”‚                         â”œâ”€ Pending payment? â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚                         â”‚  (Reuse if exists)        â”‚ â”‚           â”‚
â”‚                         â”œâ”€ Create RZ Order â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ â”‚ RAZORPAY  â”‚
â”‚                         â”‚                           â”‚ â”‚ receives  â”‚
â”‚                         â”œâ”€ Get orderId â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚ request   â”‚
â”‚                         â”œâ”€ Save Payment  â”‚ PAYMENT {status:PENDING,â”‚
â”‚                         â”‚   in DB        â”‚ gatewayOrderId: "rz123"}â”‚
â”‚                         â””â”€ Return        â”‚                        â”‚
â”‚                            {             â”‚                        â”‚
â”‚     Get RZ data â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  key: "KEY", â”‚                        â”‚
â”‚     {key, orderId, amount}    orderId: "rz123",                    â”‚
â”‚                               amount: 19998                        â”‚
â”‚                            }                                       â”‚
â”‚                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ PHASE 3: RAZORPAY PAYMENT MODAL                                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                     â”‚
â”‚  Frontend                      Razorpay Modal                      â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€                      â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                      â”‚
â”‚                                                                     â”‚
â”‚  4. Open Razorpay Modal                                            â”‚
â”‚     with {key, orderId}  â”€â”€â”€â†’ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚                               â”‚  ğŸ’³ PAYMENT FORM     â”‚            â”‚
â”‚                               â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€    â”‚            â”‚
â”‚                               â”‚  Card: [__________]  â”‚            â”‚
â”‚                               â”‚  Exp: [__/__]        â”‚            â”‚
â”‚                               â”‚  CVV: [___]          â”‚            â”‚
â”‚                               â”‚                      â”‚            â”‚
â”‚                               â”‚  [PAY â‚¹199.98]       â”‚            â”‚
â”‚                               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â”‚                                     â†“                              â”‚
â”‚  5. User enters details                                           â”‚
â”‚     & clicks PAY                                                   â”‚
â”‚                                                                     â”‚
â”‚  6. Razorpay processes â†’ Bank API â†’ Payment Gateway               â”‚
â”‚                                                                     â”‚
â”‚     A) SUCCESS                  B) FAILURE                        â”‚
â”‚        â†“                           â†“                              â”‚
â”‚     Card charged âœ“             Error: Declined                    â”‚
â”‚     Razorpay generates         Razorpay callback                  â”‚
â”‚     payment_id                 payment.failed                     â”‚
â”‚                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ PHASE 4A: PAYMENT SUCCESS FLOW                                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                     â”‚
â”‚  Frontend                  Backend                    Database      â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€                  â”€â”€â”€â”€â”€â”€â”€                    â”€â”€â”€â”€â”€â”€â”€â”€      â”‚
â”‚                                                                     â”‚
â”‚  7a. Razorpay success    â”Œâ”€ payment_id: "pay_123"                 â”‚
â”‚      callback            â”‚â”€ razorpay_signature: "sig..."          â”‚
â”‚      â†“                   â”‚â”€ razorpay_order_id: "rz123"            â”‚
â”‚      â”‚                   â””â”€â†’ POST /api/payment/verify             â”‚
â”‚      â”‚                        verifyPaymentService()              â”‚
â”‚      â”‚                        â”œâ”€ Extract signature âœ“              â”‚
â”‚      â”‚                        â”œâ”€ Create expected: âœ“              â”‚
â”‚      â”‚                        â”‚  HMAC-SHA256(secret)              â”‚
â”‚      â”‚                        â”œâ”€ Match? âœ“ (GENUINE)              â”‚
â”‚      â”‚                        â”œâ”€ Update PAYMENT:                 â”‚
â”‚      â”‚                        â”‚  status â†’ PAID       PAYMENT:    â”‚
â”‚      â”‚                        â”œâ”€ Update ORDER:      {gatewayPaymentIdâ”‚
â”‚      â”‚                        â”‚  status â†’ PROCESSING gatewayOrderId: ...
â”‚      â”‚                        â”œâ”€ Send email âœ“       status: "PAID"}
â”‚      â”‚                        â””â”€ Return success                   â”‚
â”‚      â”‚                           â†“                                â”‚
â”‚      Show SUCCESS â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ {success: true}   ORDER:           â”‚
â”‚      "Payment Done!"                             {status: PROCESSING}
â”‚                                                                     â”‚
â”‚  8a. Show receipt/            (User receives order                â”‚
â”‚      redirect to orders       confirmation email)                  â”‚
â”‚                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ PHASE 4B: PAYMENT FAILURE FLOW                                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                     â”‚
â”‚  Frontend                      Backend              Database        â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€                      â”€â”€â”€â”€â”€â”€â”€              â”€â”€â”€â”€â”€â”€â”€â”€        â”‚
â”‚                                                                     â”‚
â”‚  7b. Razorpay error callback   â”Œâ”€ Webhook also might trigger     â”‚
â”‚      payment.failed             â”‚  (See Phase 5 below)            â”‚
â”‚      â†“                          â”‚                                 â”‚
â”‚  Show ERROR                     â”‚                                 â”‚
â”‚  "Payment Failed"               â”‚                                 â”‚
â”‚  [RETRY BUTTON]                â”‚                                 â”‚
â”‚      â†“                          â”‚                                 â”‚
â”‚  User clicks RETRY             â”‚                                 â”‚
â”‚      â†“                          â”‚                                 â”‚
â”‚  POST /api/payment/create-orderâ”‚                                 â”‚
â”‚      â”œâ”€ Same orderId âœ“         â”‚                                 â”‚
â”‚      â”œâ”€ Pending payment?       â”‚                                 â”‚
â”‚      â”‚  YES â†’ Reuse same       â”‚ PAYMENT table                   â”‚
â”‚      â”‚        Razorpay ID      â”‚ (no duplicate entry)            â”‚
â”‚      â”‚        (IDEMPOTENCY)    â”‚                                 â”‚
â”‚      â””â”€ Return same order      â”‚                                 â”‚
â”‚                                 â”‚                                 â”‚
â”‚  Frontend opens Razorpay again  â”‚                                 â”‚
â”‚  User pays again                â”‚                                 â”‚
â”‚      â†“                          â”‚                                 â”‚
â”‚  Success â†’ Webhook triggers    â”‚                                 â”‚
â”‚                                 â”‚                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ PHASE 5: WEBHOOK (BACKUP MECHANISM)                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                     â”‚
â”‚  Razorpay Servers          Backend                   Database      â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€          â”€â”€â”€â”€â”€â”€â”€                   â”€â”€â”€â”€â”€â”€â”€â”€      â”‚
â”‚                                                                     â”‚
â”‚  Payment completed    â†’  POST /api/payment/webhook                â”‚
â”‚  on their end             â”œâ”€ paymentService.verifyPaymentService()â”‚
â”‚                           â”œâ”€ Extract body                         â”‚
â”‚                           â”œâ”€ Create HMAC signature               â”‚
â”‚                           â”œâ”€ Verify with secret âœ“                â”‚
â”‚                           â”œâ”€ Parse event data                    â”‚
â”‚                           â”œâ”€ Update PAYMENT:                    â”‚
â”‚                           â”‚  status â†’ PAID        PAYMENT {   â”‚
â”‚                           â”œâ”€ Update ORDER:        status:PAID,â”‚
â”‚                           â”‚  status â†’ PROCESSING  gatewayPaymentId}
â”‚                           â”œâ”€ Send email                         â”‚
â”‚                           â””â”€ ALWAYS return 200                  â”‚
â”‚                                                 ORDER {status:  â”‚
â”‚                           (Even if error!)      PROCESSING}    â”‚
â”‚                                                                     â”‚
â”‚  Why return 200 even on error?                                     â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                     â”‚
â”‚  If you return error â†’ Razorpay retries                           â”‚
â”‚  â†’ Multiple webhooks â†’ Multiple PAID updates (BAD)               â”‚
â”‚  So always 200, but log errors for debugging                      â”‚
â”‚                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ PHASE 6: STOCK RECOVERY (IF USER DISAPPEARS)                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                     â”‚
â”‚  Cron Job (runs every 10 minutes)                                  â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                  â”‚
â”‚                                                                     â”‚
â”‚  Check database:                                                   â”‚
â”‚  â”œâ”€ Find orders: status = PENDING                                 â”‚
â”‚  â”œâ”€ AND: createdAt < 30 minutes ago                              â”‚
â”‚  â”œâ”€ AND: payment status NOT PAID                                 â”‚
â”‚  â”‚                                                                â”‚
â”‚  â”‚  FOUND: Order created 35 minutes ago, not paid               â”‚
â”‚  â”‚                                                                â”‚
â”‚  â”œâ”€ Cancel order â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’  ORDER: status = CANCELLED   â”‚
â”‚  â”œâ”€ Restore stock â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’  PRODUCT: stock += quantity  â”‚
â”‚  â”œâ”€ Update payment â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’  PAYMENT: status = ABANDONED â”‚
â”‚  â””â”€ Send email: "Order cancelled due to timeout"                â”‚
â”‚                                                                     â”‚
â”‚  If user comes back:                                               â”‚
â”‚  â”œâ”€ Old order is cancelled                                        â”‚
â”‚  â”œâ”€ Stock is available                                            â”‚
â”‚  â””â”€ User can create new order                                     â”‚
â”‚                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 3. Multer & Cloudinary Upload Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚            FILE UPLOAD COMPLETE ARCHITECTURE                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  FRONTEND (Browser)â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â†“
    User selects 3 images
    (product1.jpg, product2.jpg, product3.jpg)
    And form data:
    â””â”€ name: "Sony TV"
    â””â”€ price: 499.99
    â””â”€ category: "electronics"
         â†“
    FormData object created:
    â”œâ”€ file field: images (3 files)
    â”œâ”€ text field: name
    â”œâ”€ text field: price
    â””â”€ text field: category
         â†“
    POST /api/products
    Content-Type: multipart/form-data
    (Browser sends entire body as streams)
         â†“
         â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  MULTER MIDDLEWARE                      â”‚
    â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                   â”‚
    â”‚  upload.array("images", 5)              â”‚
    â”‚                                         â”‚
    â”‚  1. Parse multipart stream              â”‚
    â”‚     â”œâ”€ Read boundaries                  â”‚
    â”‚     â”œâ”€ Extract text fields              â”‚
    â”‚     â””â”€ Extract file streams             â”‚
    â”‚                                         â”‚
    â”‚  2. Validate each file:                 â”‚
    â”‚     â”œâ”€ product1.jpg                    â”‚
    â”‚     â”‚  â”œâ”€ Type: image/jpeg âœ“           â”‚
    â”‚     â”‚  â”œâ”€ Size: 1.2MB < 2MB âœ“          â”‚
    â”‚     â”‚  â””â”€ fileFilter passed âœ“          â”‚
    â”‚     â”œâ”€ product2.jpg âœ“                  â”‚
    â”‚     â””â”€ product3.jpg âœ“                  â”‚
    â”‚                                         â”‚
    â”‚  3. Store in memory (memoryStorage)     â”‚
    â”‚     â”œâ”€ product1 â†’ Buffer[0]            â”‚
    â”‚     â”œâ”€ product2 â†’ Buffer[1]            â”‚
    â”‚     â””â”€ product3 â†’ Buffer[2]            â”‚
    â”‚                                         â”‚
    â”‚  4. Populate req                        â”‚
    â”‚     â”œâ”€ req.body = {                    â”‚
    â”‚     â”‚    name: "Sony TV",              â”‚
    â”‚     â”‚    price: "499.99",              â”‚
    â”‚     â”‚    category: "electronics"       â”‚
    â”‚     â”‚  }                                â”‚
    â”‚     â””â”€ req.files = [Buffer1, B2, B3]   â”‚
    â”‚                                         â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â†“
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  VALIDATION MIDDLEWARE                  â”‚
    â”‚  (validate.middleware)                  â”‚
    â”‚                                         â”‚
    â”‚  Validate schema:                       â”‚
    â”‚  â”œâ”€ name: string, min 3 âœ“              â”‚
    â”‚  â”œâ”€ price: number > 0 âœ“                â”‚
    â”‚  â”œâ”€ category: string âœ“                 â”‚
    â”‚  â””â”€ All required fields present âœ“      â”‚
    â”‚                                         â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â†“
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  CONTROLLER                             â”‚
    â”‚  (productController.createProduct)      â”‚
    â”‚                                         â”‚
    â”‚  Call service:                          â”‚
    â”‚  productService.addProductService(      â”‚
    â”‚    req.body,    // Form data           â”‚
    â”‚    req.user._id, // User ID (from JWT) â”‚
    â”‚    req.files    // File buffers        â”‚
    â”‚  )                                      â”‚
    â”‚                                         â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â†“
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  SERVICE LAYER                          â”‚
    â”‚  (product.service.js)                   â”‚
    â”‚                                         â”‚
    â”‚  if (files?.length) {                  â”‚
    â”‚                                         â”‚
    â”‚    FOR EACH file in req.files:          â”‚
    â”‚    â”œâ”€ file = Buffer[i]                 â”‚
    â”‚    â”œâ”€ Upload to Cloudinary             â”‚
    â”‚    â”‚  API call:                         â”‚
    â”‚    â”‚  cloudinary.uploader.upload(       â”‚
    â”‚    â”‚    file.buffer  // â† Actual bytes  â”‚
    â”‚    â”‚  )                                 â”‚
    â”‚    â”‚                                    â”‚
    â”‚    â”‚  â†“ (Over HTTPS to Cloudinary)     â”‚
    â”‚    â”‚                                    â”‚
    â”‚    â”œâ”€ Receive response:                â”‚
    â”‚    â”‚  {                                â”‚
    â”‚    â”‚    public_id: "prod/xyz123",      â”‚
    â”‚    â”‚    secure_url: "https://..."      â”‚
    â”‚    â”‚  }                                â”‚
    â”‚    â”‚                                    â”‚
    â”‚    â””â”€ Store in images array            â”‚
    â”‚                                         â”‚
    â”‚  images = [                             â”‚
    â”‚    {                                    â”‚
    â”‚      public_id: "prod/abc",            â”‚
    â”‚      url: "https://res.cloudinary..."  â”‚
    â”‚    },                                   â”‚
    â”‚    { ... },                             â”‚
    â”‚    { ... }                              â”‚
    â”‚  ]                                      â”‚
    â”‚                                         â”‚
    â”‚  } else {                               â”‚
    â”‚    Use default image                    â”‚
    â”‚  }                                      â”‚
    â”‚                                         â”‚
    â”‚  Create Product in DB:                 â”‚
    â”‚  Product.create({                       â”‚
    â”‚    name: "Sony TV",                    â”‚
    â”‚    price: 499.99,                      â”‚
    â”‚    images: [... uploaded URLs ...],    â”‚
    â”‚    category: "electronics",            â”‚
    â”‚    createdBy: adminId                  â”‚
    â”‚  })                                     â”‚
    â”‚                                         â”‚
    â”‚  return product                         â”‚
    â”‚                                         â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â†“
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  DATABASE STORAGE                       â”‚
    â”‚  (MongoDB)                              â”‚
    â”‚                                         â”‚
    â”‚  Product document saved:                â”‚
    â”‚  {                                      â”‚
    â”‚    _id: ObjectId("..."),               â”‚
    â”‚    name: "Sony TV",                    â”‚
    â”‚    price: 499.99,                      â”‚
    â”‚    images: [                            â”‚
    â”‚      {                                  â”‚
    â”‚        public_id: "prod/abc123",       â”‚
    â”‚        url: "https://res.cloudinary.."â”‚
    â”‚      },                                 â”‚
    â”‚      { ... },                           â”‚
    â”‚      { ... }                            â”‚
    â”‚    ],                                   â”‚
    â”‚    category: "electronics",            â”‚
    â”‚    createdBy: ObjectId("..."),        â”‚
    â”‚    createdAt: ISODate("..."),         â”‚
    â”‚    updatedAt: ISODate("...")          â”‚
    â”‚  }                                      â”‚
    â”‚                                         â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â†“
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  RESPONSE TO FRONTEND                   â”‚
    â”‚                                         â”‚
    â”‚  201 Created                            â”‚
    â”‚  {                                      â”‚
    â”‚    success: true,                       â”‚
    â”‚    message: "Product created",         â”‚
    â”‚    data: {                              â”‚
    â”‚      _id: "...",                       â”‚
    â”‚      name: "Sony TV",                  â”‚
    â”‚      price: 499.99,                    â”‚
    â”‚      images: [                          â”‚
    â”‚        {url: "https://res.cloudinary."}â”‚
    â”‚      ],                                 â”‚
    â”‚      ...                                â”‚
    â”‚    }                                    â”‚
    â”‚  }                                      â”‚
    â”‚                                         â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â†“
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  FRONTEND RENDERING                     â”‚
    â”‚                                         â”‚
    â”‚  â”œâ”€ Display product name âœ“             â”‚
    â”‚  â”œâ”€ Display price âœ“                    â”‚
    â”‚  â”œâ”€ Load images from Cloudinary URLs   â”‚
    â”‚  â”‚  â””â”€ Browser cache optimization      â”‚
    â”‚  â”‚  â””â”€ CDN delivers from nearest edge  â”‚
    â”‚  â””â”€ Show product details               â”‚
    â”‚                                         â”‚
    â”‚  Product image displayed via:          â”‚
    â”‚  <img src="https://res.cloudinary..."/>
    â”‚                                         â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


IMAGE LIFECYCLE AFTER CREATION:
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

1. STORED ON CLOUDINARY CDN
   â”œâ”€ Global edge servers
   â”œâ”€ Automatic optimization
   â””â”€ Available 24/7

2. REFERENCED IN DATABASE
   â”œâ”€ MongoDB stores URLs only
   â”œâ”€ No actual image data in DB
   â””â”€ URLs are immutable

3. DISPLAYED ON FRONTEND
   â”œâ”€ Browser requests from Cloudinary
   â”œâ”€ CDN serves from nearest edge
   â””â”€ Cached in browser

4. DELETION (if needed)
   â”œâ”€ Delete from MongoDB
   â”œâ”€ Call: cloudinary.uploader.destroy(public_id)
   â””â”€ File removed from CDN
```

---

## 4. Complete Sequence Diagram

```
Timeline: User Journey from Registration to Delivery

â”Œâ”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚Time  â”‚User  â”‚Frontend  â”‚Backendâ”‚ Database & Services              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚      â”‚      â”‚          â”‚      â”‚                                    â”‚
â”‚T+0s  â”‚Enter â”‚Show      â”‚      â”‚                                    â”‚
â”‚      â”‚name, â”‚register  â”‚      â”‚                                    â”‚
â”‚      â”‚email â”‚form      â”‚      â”‚                                    â”‚
â”‚      â”‚pass  â”‚          â”‚      â”‚                                    â”‚
â”‚      â”‚      â”‚          â”‚      â”‚                                    â”‚
â”‚T+5s  â”‚Click â”‚Validate  â”‚POST /api/auth/register               â”‚
â”‚      â”‚Registerâ”‚data    â”‚â”œâ”€ Hash password                        â”‚
â”‚      â”‚      â”‚          â”‚â”œâ”€ Generate OTP                         â”‚
â”‚      â”‚      â”‚          â”‚â”œâ”€ Send email                           â”‚
â”‚      â”‚      â”‚          â”‚â””â”€ Return userId             USER {      â”‚
â”‚      â”‚      â”‚          â”‚                            isVerified:0}â”‚
â”‚      â”‚      â”‚          â”‚                                        â”‚
â”‚T+10s â”‚      â”‚Show OTP  â”‚      â”‚(User gets email with OTP)        â”‚
â”‚      â”‚Enter â”‚input     â”‚      â”‚                                    â”‚
â”‚      â”‚OTP   â”‚field     â”‚      â”‚                                    â”‚
â”‚      â”‚      â”‚          â”‚      â”‚                                    â”‚
â”‚T+15s â”‚Click â”‚Validate  â”‚POST /api/auth/verify-otp              â”‚
â”‚      â”‚Verifyâ”‚OTP       â”‚â”œâ”€ Verify OTP matches                   â”‚
â”‚      â”‚      â”‚          â”‚â”œâ”€ Check not expired                    â”‚
â”‚      â”‚      â”‚          â”‚â””â”€ Mark verified        USER {          â”‚
â”‚      â”‚      â”‚          â”‚                        isVerified:1}   â”‚
â”‚      â”‚      â”‚          â”‚                                        â”‚
â”‚T+20s â”‚      â”‚Success!  â”‚      â”‚                                    â”‚
â”‚      â”‚Click â”‚Redirect  â”‚      â”‚                                    â”‚
â”‚      â”‚Login â”‚to login  â”‚      â”‚                                    â”‚
â”‚      â”‚      â”‚          â”‚      â”‚                                    â”‚
â”‚T+30s â”‚Enter â”‚Validate  â”‚POST /api/auth/login                   â”‚
â”‚      â”‚email â”‚(rate     â”‚â”œâ”€ Rate limit: 5/15min âœ“               â”‚
â”‚      â”‚pass  â”‚limit)    â”‚â”œâ”€ Find user by email                   â”‚
â”‚      â”‚      â”‚          â”‚â”œâ”€ Compare password                     â”‚
â”‚      â”‚Click â”‚          â”‚â”œâ”€ Generate JWT (7 days)                â”‚
â”‚      â”‚Login â”‚          â”‚â”œâ”€ Generate refresh token               â”‚
â”‚      â”‚      â”‚          â”‚â””â”€ Return accessToken        SET cookie:â”‚
â”‚      â”‚      â”‚          â”‚                            refreshTokenâ”‚
â”‚      â”‚      â”‚          â”‚                                        â”‚
â”‚T+35s â”‚      â”‚Store JWT â”‚      â”‚                                    â”‚
â”‚      â”‚Browseâ”‚in memory â”‚      â”‚                                    â”‚
â”‚      â”‚shop  â”‚or        â”‚      â”‚                                    â”‚
â”‚      â”‚      â”‚localStorage      â”‚                                  â”‚
â”‚      â”‚      â”‚          â”‚      â”‚                                    â”‚
â”‚T+40s â”‚Click â”‚Send GET  â”‚GET /api/products?page=1               â”‚
â”‚      â”‚productâ”‚with JWT â”‚â”œâ”€ Verify JWT âœ“                        â”‚
â”‚      â”‚list  â”‚          â”‚â”œâ”€ Check pagination                     â”‚
â”‚      â”‚      â”‚          â”‚â”œâ”€ Filter products                      â”‚
â”‚      â”‚      â”‚          â”‚â””â”€ Return 10 products                   â”‚
â”‚      â”‚      â”‚          â”‚                                        â”‚
â”‚T+45s â”‚      â”‚Display   â”‚      â”‚                                    â”‚
â”‚      â”‚View  â”‚products  â”‚      â”‚                                    â”‚
â”‚      â”‚with  â”‚images    â”‚      â”‚                                    â”‚
â”‚      â”‚imagesâ”‚from      â”‚      â”‚                                    â”‚
â”‚      â”‚      â”‚Cloudinaryâ”‚      â”‚                                    â”‚
â”‚      â”‚      â”‚          â”‚      â”‚                                    â”‚
â”‚T+50s â”‚Click â”‚Show      â”‚      â”‚                                    â”‚
â”‚      â”‚add toâ”‚product   â”‚      â”‚                                    â”‚
â”‚      â”‚cart  â”‚details   â”‚      â”‚                                    â”‚
â”‚      â”‚      â”‚          â”‚      â”‚                                    â”‚
â”‚T+55s â”‚Click â”‚POST      â”‚POST /api/cart                          â”‚
â”‚      â”‚add toâ”‚/api/cart â”‚â”œâ”€ Validate product                     â”‚
â”‚      â”‚cart  â”‚with qty  â”‚â”œâ”€ Add to user's cart                   â”‚
â”‚      â”‚      â”‚          â”‚â””â”€ Return updated cart      CART {item} â”‚
â”‚      â”‚      â”‚          â”‚                                        â”‚
â”‚T+60s â”‚      â”‚Show      â”‚      â”‚                                    â”‚
â”‚      â”‚View  â”‚"Added"   â”‚      â”‚                                    â”‚
â”‚      â”‚cart  â”‚toast     â”‚      â”‚                                    â”‚
â”‚      â”‚      â”‚          â”‚      â”‚                                    â”‚
â”‚T+70s â”‚Click â”‚Show      â”‚      â”‚                                    â”‚
â”‚      â”‚check â”‚address   â”‚      â”‚                                    â”‚
â”‚      â”‚out   â”‚form      â”‚      â”‚                                    â”‚
â”‚      â”‚      â”‚          â”‚      â”‚                                    â”‚
â”‚T+75s â”‚Enter â”‚Validate  â”‚POST /api/orders                        â”‚
â”‚      â”‚      â”‚address   â”‚â”œâ”€ Get user's cart                      â”‚
â”‚      â”‚addressâ”‚         â”‚â”œâ”€ Validate address                     â”‚
â”‚      â”‚Click â”‚          â”‚â”œâ”€ CREATE order                         â”‚
â”‚      â”‚place â”‚          â”‚â”œâ”€ DEDUCT stock    ORDER {status: PENDING
â”‚      â”‚order â”‚          â”‚â”œâ”€ CLEAR cart                PRODUCT stock-n
â”‚      â”‚      â”‚          â”‚â””â”€ Return orderId  CART {}  â”‚
â”‚      â”‚      â”‚          â”‚                                        â”‚
â”‚T+80s â”‚      â”‚Show      â”‚      â”‚                                    â”‚
â”‚      â”‚      â”‚razorpay  â”‚      â”‚                                    â”‚
â”‚      â”‚      â”‚button    â”‚      â”‚                                    â”‚
â”‚      â”‚      â”‚          â”‚      â”‚                                    â”‚
â”‚T+85s â”‚Click â”‚POST      â”‚POST /api/payment/create-order          â”‚
â”‚      â”‚Pay   â”‚/api/paymentâ”‚â”œâ”€ Verify order                       â”‚
â”‚      â”‚      â”‚/create-orderâ”‚â”œâ”€ Create Razorpay order             â”‚
â”‚      â”‚      â”‚          â”‚â”œâ”€ Save payment record                  â”‚
â”‚      â”‚      â”‚          â”‚â””â”€ Return orderId    PAYMENT {          â”‚
â”‚      â”‚      â”‚          â”‚                    status: PENDING}    â”‚
â”‚      â”‚      â”‚          â”‚                                        â”‚
â”‚T+90s â”‚      â”‚Open      â”‚      â”‚                                    â”‚
â”‚      â”‚      â”‚Razorpay  â”‚      â”‚                                    â”‚
â”‚      â”‚      â”‚modal     â”‚      â”‚                                    â”‚
â”‚      â”‚      â”‚          â”‚      â”‚                                    â”‚
â”‚T+95s â”‚Enter â”‚          â”‚      â”‚ â”€â”€â”€ RAZORPAY PROCESSES â”€â”€â”€        â”‚
â”‚      â”‚card  â”‚          â”‚      â”‚                                    â”‚
â”‚      â”‚      â”‚          â”‚      â”‚                                    â”‚
â”‚T+100sâ”‚Click â”‚          â”‚      â”‚ Card charged, payment complete   â”‚
â”‚      â”‚PAY   â”‚          â”‚      â”‚ Razorpay sends callback          â”‚
â”‚      â”‚      â”‚          â”‚      â”‚                                    â”‚
â”‚T+105sâ”‚      â”‚Handle    â”‚POST /api/payment/verify                â”‚
â”‚      â”‚      â”‚success   â”‚â”œâ”€ Verify signature                     â”‚
â”‚      â”‚      â”‚callback  â”‚â”œâ”€ Update payment â†’ PAID                â”‚
â”‚      â”‚      â”‚          â”‚â”œâ”€ Update order â†’ PROCESSING            â”‚
â”‚      â”‚      â”‚          â”‚â”œâ”€ Send email                           â”‚
â”‚      â”‚      â”‚          â”‚â””â”€ Return success        PAYMENT {      â”‚
â”‚      â”‚      â”‚          â”‚                        status: PAID}  â”‚
â”‚      â”‚      â”‚          â”‚                        ORDER {        â”‚
â”‚      â”‚      â”‚          â”‚                        status:PROCESSING}
â”‚      â”‚      â”‚          â”‚      â”‚(User receives confirmation)     â”‚
â”‚      â”‚      â”‚          â”‚      â”‚                                    â”‚
â”‚T+110sâ”‚      â”‚Show      â”‚      â”‚                                    â”‚
â”‚      â”‚      â”‚success   â”‚      â”‚                                    â”‚
â”‚      â”‚      â”‚& order   â”‚      â”‚                                    â”‚
â”‚      â”‚      â”‚details   â”‚      â”‚                                    â”‚
â”‚      â”‚      â”‚          â”‚      â”‚                                    â”‚
â”‚T+1dayâ”‚      â”‚Check     â”‚GET /api/orders                         â”‚
â”‚      â”‚      â”‚order     â”‚â”œâ”€ Return all user orders               â”‚
â”‚      â”‚      â”‚status    â”‚â””â”€ Order showing SHIPPED                â”‚
â”‚      â”‚      â”‚          â”‚                    (admin updated)     â”‚
â”‚      â”‚      â”‚          â”‚                                        â”‚
â”‚T+5dayâ”‚      â”‚Check     â”‚ORDER status: DELIVERED                 â”‚
â”‚      â”‚      â”‚track     â”‚(Admin marks as delivered)              â”‚
â”‚      â”‚      â”‚order     â”‚                                        â”‚
â”‚      â”‚      â”‚          â”‚                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

This completes the full visual breakdown of your system! ğŸ‰

**All critical flows covered:**

- âœ… Rate limiting
- âœ… Payment gateway
- âœ… File uploads
- âœ… Complete user journey
